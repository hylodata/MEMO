<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapbox Draw & Export with Local GeoJSON</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.0/mapbox-gl.js"></script>
    <script src="https://unpkg.com/@mapbox/mapbox-gl-draw@1.3.0/dist/mapbox-gl-draw.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.0/mapbox-gl.css" rel="stylesheet">
    <link href="https://unpkg.com/@mapbox/mapbox-gl-draw@1.3.0/dist/mapbox-gl-draw.css" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; }
        #map { width: 100vw; height: 100vh; }
        .buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .btn {
            background: white;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            border: 1px solid #ccc;
            text-align: center;
        }
    </style>
</head>
<body>

<div id="map"></div>

<div class="buttons">
    <button class="btn" id="add-layer">Add Local GeoJSON Layer</button>
    <button class="btn" id="export-geojson">Export GeoJSON</button>
</div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiZ2JieSIsImEiOiJjbDRnMnhpcWowOTZ0M2ltYmVidmFlYzUyIn0.YMvE-Zv6jfxhACw69xOvLQ';
const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/gbby/cl59w4ws5000v15qti5ts2dlf',
    center: [8.134336, 8.867609],
    zoom: 6,
    preserveDrawingBuffer: true,
    projection: 'globe'
});

    // Initialize Draw Control
    const draw = new MapboxDraw({
        displayControlsDefault: false,
        controls: {
            polygon: true,
            line_string: true,
            point: true,
            trash: true
        }
    });

    map.addControl(draw, 'top-left');

    let addedLayer = false; // Track if the local layer has been added

    // Function to load a local GeoJSON file and add it to the map
    async function addLocalGeoJSON() {
        if (addedLayer) return; // Prevent multiple additions

        try {
            const response = await fetch('nigeria_test.geojson'); // Load GeoJSON from local directory
            if (!response.ok) throw new Error("Failed to load GeoJSON file");

            const geojsonData = await response.json();

            map.addSource('Nigeria_test', {
        'type': 'geojson',
        'data': geojsonData
    });

    // MLDS 2005
    map.addLayer({
        'id': 'Nigeria_test',
        'type': 'fill',
        'source': 'Nigeria_test',
        'layout': {
            'visibility': 'none'
        },
        'paint': {
            'fill-color': {
                property: 'Nigeria_MLDS_Yrs25km_MLDSRate2005',
                stops: [
                    [-0.33651, "#feedde"],
                    [-0.116, '#fdd0a2'],
                    [-0.05818, '#fdae6b'],
                    [-0.01087, '#fd8d3c'],
                    [0.03989, '#f16913'],
                    [0.09784, '#d94801'],
                    [0.64773, '#8c2d04']
                ]
            },
            'fill-opacity': 0.95
        }
    });

            addedLayer = true;
        } catch (error) {
            alert("Error loading GeoJSON: " + error.message);
        }
    }

    // Button click event to load the local GeoJSON file
    document.getElementById('add-layer').addEventListener('click', addLocalGeoJSON);

    // Export function
    document.getElementById('export-geojson').addEventListener('click', async () => {
        const drawnData = draw.getAll();

        // Get added layer data if available
        let addedLayerData = map.getSource('Nigeria_test') ? map.getSource('Nigeria_test')._data : null;

        // Merge both drawn and added data
        let mergedGeoJSON = {
            type: "FeatureCollection",
            features: [...drawnData.features]
        };

        if (addedLayerData) {
            mergedGeoJSON.features.push(...addedLayerData.features);
        }

        if (mergedGeoJSON.features.length === 0) {
            alert("No data to export!");
            return;
        }

        // Convert merged data to a downloadable file
        const blob = new Blob([JSON.stringify(mergedGeoJSON)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'exported-data.geojson';
        a.click();
        URL.revokeObjectURL(url);
    });
</script>

</body>
</html>
